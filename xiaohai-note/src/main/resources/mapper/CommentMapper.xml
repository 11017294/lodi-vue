<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiaohai.note.dao.CommentMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.xiaohai.note.pojo.entity.Comment">
        <id column="id" property="id" />
        <result column="created_time" property="createdTime" />
        <result column="parent_id" property="parentId" />
        <result column="article_id" property="articleId" />
        <result column="user_id" property="userId" />
        <result column="content" property="content" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        created_time,
        id, parent_id, article_id, user_id, content
    </sql>
    <select id="findCommentListByPage" resultType="com.xiaohai.note.pojo.dto.CommentDto">
        SELECT
        c.id,
        c.parent_id as parentId,
        c.article_id as articleId,
        c.user_id as userId,
        c.content,
        COALESCE(u.nick_name, u.username) AS username,
        u.avatar,
        a.title,
        c.created_time as createdTime
        FROM
        b_comment c
        LEFT JOIN b_article a ON a.id = c.article_id
        LEFT JOIN sys_user u ON u.id = c.user_id
        <where>
            <if test="query.content != null and query.content != ''">
                and c.content like CONCAT(#{query.content},'%')
            </if>
            <if test="query.username != null and query.username != ''">
               and u.username  like CONCAT(#{query.username},'%') or u.nick_name like CONCAT(#{query.username},'%')
            </if>
        </where>
        ORDER BY
        c.created_time DESC
    </select>
    <select id="findCommentList" resultType="com.xiaohai.common.daomain.CommentTree">
        SELECT
            c.id,
            c.parent_id as parentId,
            c.article_id as articleId,
            c.user_id as userId,
            c.content,
            COALESCE(u.nick_name, u.username) AS username,
            u.avatar,
            a.title,
            c.created_time as createdTime
        FROM
            b_comment c
                LEFT JOIN b_article a ON a.id = c.article_id
                LEFT JOIN sys_user u ON u.id = c.user_id
        where
            c.article_id=#{articleId}
        ORDER BY
            c.created_time ASC
    </select>

</mapper>
